---
phase: 5
plan: 2
wave: 1
---

# Plan 5.2: Validation Engine with ISSUES Output

## Objective
Rewrite validateTasksData() into a robust validation engine that writes errors to the ISSUES sheet instead of (only) alerting. Add validation for unique IDs and project existence.

## Context
- Validation.gs — current alert-based validation
- Config.gs — SHEET_ISSUES, HEADERS_ISSUES, VALID_STATUSES
- Helpers.gs — getHeaderMap_, getColIndex_

## Tasks

<task type="auto">
  <name>Rewrite validateTasksData to output to ISSUES sheet</name>
  <files>Validation.gs</files>
  <action>
    1. At the start of validateTasksData(), get (or create) the ISSUES sheet and clear its data rows (keep headers).
    2. Build the errors array as objects: `{fecha, hoja, fila, campo, mensaje, severidad}`.
    3. Add new validation rules:
       - ID uniqueness check (collect all IDs, flag duplicates). Severidad: 'Error'.
       - Proyecto must exist in PROJECTS sheet (read PROJECTS.Nombre list). Severidad: 'Error'.
       - Existing checks remain: Proyecto not empty, Tarea not empty, dates valid, Inicio <= Fin, Estado valid.
    4. Write all errors to ISSUES sheet as rows.
    5. Show a summary alert: "Se encontraron X errores. Ver hoja ISSUES para detalle."
    6. If no errors, clear ISSUES and alert success.
  </action>
  <verify>Select-String -Path "Validation.gs" -Pattern "SHEET_ISSUES", "HEADERS_ISSUES"</verify>
  <done>Validation writes to ISSUES sheet with structured rows. Duplicate IDs and invalid projects are caught.</done>
</task>

<task type="auto">
  <name>Add validateProjectsData function</name>
  <files>Validation.gs, Main.gs</files>
  <action>
    1. Create validateProjectsData() in Validation.gs:
       - Validate ProyectoID not empty, Nombre not empty.
       - Validate Estado is in VALID_STATUSES.
       - Validate Inicio <= Fin (if both dates present).
       - Validate unique ProyectoID.
       - Output errors to ISSUES sheet (append, don't clear — validateTasksData clears first).
    2. Update validateTasksData() to call validateProjectsData() first, then validate tasks.
    3. Rename menu item "Validar datos" to call a new wrapper function `runFullValidation()` that runs both.
    4. Update Main.gs menu to point to `runFullValidation`.
  </action>
  <verify>Select-String -Path "Validation.gs" -Pattern "validateProjectsData"</verify>
  <done>PROJECTS validation exists, menu runs full validation, errors go to ISSUES.</done>
</task>

## Success Criteria
- [ ] Validation writes structured errors to ISSUES sheet
- [ ] Duplicate task IDs are detected
- [ ] Invalid project references are detected
- [ ] PROJECTS data is validated (Estado, dates, unique ProyectoID)
- [ ] Menu runs combined validation
