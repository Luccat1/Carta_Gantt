---
phase: 9
plan: 2
wave: 1
---

# Plan 9.2: AppSheet Action Columns & Triggers

## Objective
Add action-compatible infrastructure so AppSheet can trigger Apps Script functions. AppSheet actions work via:
- A designated "action column" that AppSheet writes to (e.g., `_Acción`)
- An `onEdit` trigger that detects changes to this column and dispatches to the appropriate function

This enables users to trigger "Refrescar Dashboard", "Actualizar estados", etc. from AppSheet's UI.

## Context
- Config.gs — HEADERS_TASKS
- Main.gs — onOpen menu items (list of available actions)
- Gantt.gs — refreshGanttView, refreshDashboard, updateProjectStatuses

## Tasks

<task type="auto">
  <name>Add _Acción column to TASKS and implement onEdit dispatcher</name>
  <files>Config.gs, Main.gs</files>
  <action>
    1. In Config.gs: Add `'_Acción'` as the LAST item in HEADERS_TASKS array
    2. In Main.gs: Create `onEditDispatcher_(e)` function that:
       a. Checks if the edited sheet is TASKS
       b. Checks if the edited column is `_Acción`
       c. Reads the cell value (e.g., 'Refrescar', 'Estados', 'Dashboard')
       d. Dispatches to the correct function:
          - 'Refrescar' → refreshGanttView()
          - 'Estados' → autoUpdateProjectStatuses_()
          - 'Dashboard' → refreshDashboard()
       e. Clears the action cell after execution
       f. Logs the action to the Logger
    3. Create an installable trigger setup function `setupAppSheetTrigger()` that:
       a. Checks if an onEdit trigger already exists for this spreadsheet
       b. If not, creates one via ScriptApp.newTrigger('onEditDispatcher_')
       c. Shows confirmation alert
    4. In Main.gs `onOpen()`: Add menu item "⚡ Configurar trigger AppSheet" calling `setupAppSheetTrigger`
    - Do NOT use the simple `onEdit(e)` trigger (it has limited permissions). Use an installable trigger.
  </action>
  <verify>Code review: _Acción column added, dispatcher handles 3 actions, trigger setup function exists</verify>
  <done>AppSheet can trigger script actions by writing to the _Acción column</done>
</task>

<task type="auto">
  <name>Add _Acción validation dropdown to TASKS</name>
  <files>Main.gs</files>
  <action>
    1. In Main.gs `initStructure()`, after the Estado validation block:
       a. Define valid actions: `['', 'Refrescar', 'Estados', 'Dashboard']`
       b. Apply data validation (dropdown) to the `_Acción` column range (row 2+)
       c. This ensures AppSheet also shows a clean dropdown for the action column
  </action>
  <verify>Code review: validation rule applied to _Acción column</verify>
  <done>_Acción column has a validated dropdown list</done>
</task>

## Success Criteria
- [ ] HEADERS_TASKS includes `_Acción` as last column
- [ ] onEditDispatcher_ handles action dispatch and cell clearing
- [ ] Installable trigger setup function available from menu
- [ ] _Acción column has dropdown validation
