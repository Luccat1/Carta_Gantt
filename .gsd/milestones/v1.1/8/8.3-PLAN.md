---
phase: 8
plan: 3
wave: 2
---

# Plan 8.3: Rollover Mejorado & Plantillas

## Objective
Enhance the existing rollover process and add a project template system for quick project setup.

**Rollover improvements:**
- Archive only `Terminado` + `Cancelado` tasks (currently archives by date only)
- Show a summary of what will be archived before proceeding
- Update project statuses after rollover

**Plantillas:**
- Add a `TEMPLATES` sheet where users define reusable task sets per project type
- Provide a menu item to instantiate a template into TASKS for a given project

## Context
- .gsd/SPEC.md
- Config.gs â€” SHEET_TASKS, HEADERS_TASKS, VALID_STATUSES
- Rollover.gs â€” rolloverToNextYear (to be enhanced)
- Main.gs â€” onOpen menu
- Helpers.gs â€” getHeaderMap_, getColIndex_, generateTaskId_

## Tasks

<task type="auto">
  <name>Enhance rolloverToNextYear with status-based filtering and summary</name>
  <files>Rollover.gs</files>
  <action>
    Modify `rolloverToNextYear()` to:
    1. Change archive logic: only archive tasks where Estado is `Terminado` OR `Cancelado` AND Fin < cutoff date (keep current date check as secondary guard)
    2. Before the confirmation dialog, compute a summary:
       - Count of tasks to archive
       - Count of tasks to keep
       - List of projects affected
    3. Display the summary in the confirmation alert
    4. After rollover (after buildCalendarFromConfig + refreshGanttView calls), call `autoUpdateProjectStatuses_()` to recalculate project statuses
    - Do NOT change the archiving sheet naming convention
  </action>
  <verify>Code review: archive logic uses status check, summary is computed, auto-estados call exists</verify>
  <done>Rollover archives only completed/canceled tasks, shows summary, updates project statuses</done>
</task>

<task type="auto">
  <name>Implement project templates system</name>
  <files>Config.gs, Main.gs, Helpers.gs</files>
  <action>
    1. In Config.gs: Add `SHEET_TEMPLATES = 'TEMPLATES'` constant and `HEADERS_TEMPLATES = ['Plantilla', 'Tarea', 'Area', 'Subarea', 'Responsable', 'DuraciÃ³nDÃ­as']` array
    2. In Main.gs `initStructure()`: Add TEMPLATES sheet creation with headers and warning-only protection
    3. In Main.gs: Add `applyTemplate()` function that:
       a. Reads all template names from TEMPLATES sheet (unique values of column 'Plantilla')
       b. Shows a dialog asking user to pick a template name and a target project name (from PROJECTS)
       c. For each task row in that template, generates a new ID, sets Proyecto to the target, calculates Inicio/Fin based on today + DuraciÃ³nDÃ­as offset, sets Estado to 'No iniciado'
       d. Appends the new tasks to TASKS sheet
    4. In Main.gs `onOpen()`: Add menu item "ðŸ“‹ Aplicar plantilla" calling `applyTemplate`
  </action>
  <verify>Code review: TEMPLATES sheet created, template application logic handles all fields</verify>
  <done>Templates sheet exists, menu item applies template creating tasks with correct dates and IDs</done>
</task>

## Success Criteria
- [ ] Rollover only archives Terminado/Cancelado tasks
- [ ] Rollover shows pre-archive summary
- [ ] TEMPLATES sheet is created by initStructure
- [ ] Applying a template creates correctly dated tasks in TASKS
