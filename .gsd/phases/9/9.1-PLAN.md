---
phase: 9
plan: 1
wave: 1
---

# Plan 9.1: Data Normalization for AppSheet

## Objective
Make the TASKS and PROJECTS tables AppSheet-ready by ensuring each row has a unique key column (`RowID`) and that relational references use matching key values. AppSheet requires:
- A unique key column per table (not the auto-generated ID — AppSheet prefers a stable, readable key)
- Ref columns that exactly match key values in related tables
- No merged cells, no formulas in data rows (already satisfied)

## Context
- Config.gs — HEADERS_TASKS, HEADERS_PROJECTS
- Main.gs — initStructure (header setup, validation rules)
- Helpers.gs — generateTaskId_, getHeaderMap_

## Tasks

<task type="auto">
  <name>Add RowID columns to TASKS and PROJECTS for AppSheet keys</name>
  <files>Config.gs, Main.gs</files>
  <action>
    1. In Config.gs, the TASKS table already has an `ID` column (auto-generated via `generateTaskId_`). This is suitable as the AppSheet key. No change needed for TASKS.
    2. In Config.gs, the PROJECTS table already has `ProyectoID`. This is suitable as the AppSheet key. No change needed for PROJECTS.
    3. Verify the `Proyecto` column in TASKS references project `Nombre` (not `ProyectoID`). For AppSheet Ref compatibility, add a helper function `ensureProjectIds_()` in Helpers.gs that:
       - Iterates TASKS rows
       - For any task missing an `ID`, generates one via `generateTaskId_()`
       - Writes only the missing IDs back (does NOT overwrite existing IDs)
    4. Call `ensureProjectIds_()` at the end of `initStructure()` so IDs are always populated
  </action>
  <verify>Code review: ensureProjectIds_ exists, called from initStructure</verify>
  <done>Every TASKS row is guaranteed to have a unique ID after initStructure runs</done>
</task>

<task type="auto">
  <name>Add an APPSHEET_CONFIG sheet with metadata for AppSheet setup</name>
  <files>Config.gs, Main.gs</files>
  <action>
    1. In Config.gs: Add `SHEET_APPSHEET = 'APPSHEET_CONFIG'` constant
    2. In Config.gs: Add `HEADERS_APPSHEET = ['Parámetro', 'Valor', 'Descripción']` array
    3. In Main.gs `initStructure()`: Create the APPSHEET_CONFIG sheet if missing, with headers and seed rows:
       - Row: 'Tabla Principal', 'TASKS', 'Hoja de tareas para AppSheet'
       - Row: 'Tabla Proyectos', 'PROJECTS', 'Hoja de proyectos para AppSheet'
       - Row: 'Columna Clave TASKS', 'ID', 'Clave única de cada tarea'
       - Row: 'Columna Clave PROJECTS', 'ProyectoID', 'Clave única de cada proyecto'
       - Row: 'Columna Ref', 'Proyecto', 'Referencia de TASKS→PROJECTS (usa Nombre)'
    4. Protect the sheet with warning-only
  </action>
  <verify>Code review: APPSHEET_CONFIG sheet created with correct seed data</verify>
  <done>APPSHEET_CONFIG sheet exists with key/ref metadata for AppSheet setup</done>
</task>

## Success Criteria
- [ ] All TASKS rows have a unique ID after initStructure
- [ ] APPSHEET_CONFIG sheet documents key columns and ref relationships
