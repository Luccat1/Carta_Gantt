---
phase: 4
plan: 3
wave: 2
---

# Plan 4.3: Migrate Existing Scripts to Header-Map

## Objective
Update all scripts that use hardcoded column indices to use `getHeaderMap_()` instead. This makes the system resilient to column reordering.

## Context
- Helpers.gs (getHeaderMap_, getColIndex_ from 4.1)
- Gantt.gs (uses HEADERS_TASKS.length, $F2/$G2 for Inicio/Fin)
- Rollover.gs (uses row[6] for End Date)
- Validation.gs (uses row[1], row[5], row[6])

## Tasks

<task type="auto">
  <name>Migrate Gantt.gs to header-map</name>
  <files>Gantt.gs</files>
  <action>
    1. In `refreshGanttView()`:
       - After getting `tasksSheet`, call `var hMap = getHeaderMap_(tasksSheet);`
       - Replace `HEADERS_TASKS.length` with `Object.keys(hMap).length` for range sizing.
       - In `applyOverlapConditionalFormatting_()`, pass `hMap` instead of `numStaticCols`.
    2. In `applyOverlapConditionalFormatting_()`:
       - Accept `hMap` parameter.
       - Use `var startCol = getColIndex_(hMap, 'Inicio');` and `var endCol = getColIndex_(hMap, 'Fin');`
       - Build formula dynamically: convert column index to letter (e.g., col 8 → H) for `$H2` instead of hardcoded `$F2`.
       - Add helper `colToLetter_(colIndex)` in Helpers.gs if not present.
    3. Keep the week column offset logic, but base it on `Object.keys(hMap).length` instead of `HEADERS_TASKS.length`.
  </action>
  <verify>Select-String -Path Gantt.gs -Pattern "getHeaderMap_|getColIndex_|hMap"</verify>
  <done>Gantt.gs uses header-map for all column references.</done>
</task>

<task type="auto">
  <name>Migrate Rollover.gs and Validation.gs to header-map</name>
  <files>Rollover.gs, Validation.gs</files>
  <action>
    1. **Rollover.gs** — `rolloverToNextYear()`:
       - Add `var hMap = getHeaderMap_(tasksSheet);`
       - Replace `row[6]` (End Date) with `row[getColIndex_(hMap, 'Fin') - 1]` (0-based for array access).
       - Replace `HEADERS_TASKS.length` with `Object.keys(hMap).length`.
    2. **Validation.gs** — `validateTasksData()`:
       - Add `var hMap = getHeaderMap_(tasksSheet);`
       - Replace `row[1]` (Tarea) → `row[getColIndex_(hMap, 'Tarea') - 1]`
       - Replace `row[5]` (Inicio) → `row[getColIndex_(hMap, 'Inicio') - 1]`
       - Replace `row[6]` (Fin) → `row[getColIndex_(hMap, 'Fin') - 1]`
       - Add validation for: Proyecto must not be empty, Estado must be in VALID_STATUSES.
  </action>
  <verify>Select-String -Path Rollover.gs -Pattern "getHeaderMap_|getColIndex_"; Select-String -Path Validation.gs -Pattern "getHeaderMap_|getColIndex_"</verify>
  <done>All scripts use header-map. No hardcoded column indices remain.</done>
</task>

## Success Criteria
- [ ] Zero hardcoded column indices in Gantt.gs, Rollover.gs, Validation.gs.
- [ ] Conditional formatting formula columns are dynamically resolved.
- [ ] Validation.gs checks Proyecto presence and Estado validity.
